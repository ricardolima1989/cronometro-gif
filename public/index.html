<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cron√¥metro com GIF via Servidor</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      background: #f4f4f4;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 1440px;
    }
    .col {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .secao {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .secao h2 {
      font-size: 14px;
      margin: 0 0 10px;
      color: #444;
    }
    .grupo {
      margin-bottom: 8px;
    }
    .grupo label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }
    .linha-color {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .linha-color input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
    }
    .linha-color input[type="text"] {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .linha-check {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    select, input[type="range"], input[type="number"] {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  
button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  cursor: pointer;
  margin-bottom: 10px;
}


/* Bot√£o principal */
button:not(.btn-reset):not(#cancelButton) {
  background: #28a745;
  color: white;
  box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
}

button:not(.btn-reset):not(#cancelButton):hover {
  background: #218838;
}

/* Bot√£o cancelar */
#cancelButton {
  background: #dc3545;
  color: white;
  box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
}

#cancelButton:hover {
  background: #c82333;
}

/* Bot√£o reset */
.btn-reset {
  background: #6c757d;
  color: white;
  font-size: 15px;
  box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
}

.btn-reset:hover {
  background: #5a6268;
}

/* Bot√µes desabilitados */
button:disabled {
  background: #bbb !important;
  color: #eee !important;
  box-shadow: none !important;
  cursor: not-allowed;
}

  
  
  
    #status {
      margin-top: 8px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    canvas {
      background: transparent;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    .preview {
      text-align: center;
    }
    h1 {
      grid-column: span 4;
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }
    /* Responsividade: em telas menores que 768px, empilha as colunas */
@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr; /* For√ßa uma √∫nica coluna */
	display: flex;
	flex-direction: column;
	align-items: stretch;
	
	
	
  }
  .col {
    width: 100% !important;
    max-width: 100% !important;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  canvas {
    max-width: 100%;
    height: auto;
  }
}

.secao.destaque {
  border: 2px solid #ff0000;
  box-shadow: 0 0 12px rgba(255, 0, 0, 0.3);
  animation: pulseBorda 1.5s infinite;
  position: relative;
}

@keyframes pulseBorda {
  0% { box-shadow: 0 0 12px rgba(255, 0, 0, 0.4); }
  50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
  100% { box-shadow: 0 0 12px rgba(255, 0, 0, 0.4); }
}

#progressBarOuter {
  width: 100%;
  height: 20px;
  background-color: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
  margin-top: 5px;
}

#progressBarInner {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #28a745, #45c46a);
  transition: width 0.3s ease;
  border-radius: 10px 0 0 10px;
}

#progressPercent {
  text-align: center;
  font-size: 14px;
  color: #444;
  margin-top: 5px;
  font-weight: bold;
}



  </style>
</head>
<body>
  <div class="container">
    <h1>Cron√¥metro com GIF via Servidor</h1>
    
    <!-- Coluna 1: Timer, C√≠rculo e Borda -->
    <div class="col">
      <!-- Valor Inicial do Timer -->
      <div class="secao destaque">
        <h2>Valor Inicial do Timer</h2>
		<span style="color: red; font-weight: bold; font-size: 13px;">üëá Comece por aqui!</span>
        <div class="grupo">
          <label for="initialTime">Defina o tempo inicial (segundos):</label>
          <input type="number" id="initialTime" value="30" min="1" />
        </div>
      </div>
      <!-- Configura√ß√£o do C√≠rculo -->
      <div class="secao">
        <h2>Configura√ß√£o do C√≠rculo</h2>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="circuloTransparente" onchange="atualizarCampo('circulo')">
            <label for="circuloTransparente">C√≠rculo transparente</label>
          </div>
          <label>Cor do c√≠rculo:</label>
          <div class="linha-color">
            <input type="color" id="corCirculo" value="#4A90E2" />
            <input type="text" id="hexCirculo" value="#4A90E2" />
          </div>
        </div>
        <div class="grupo">
          <label for="grossuraCirculo">
            Grossura do c√≠rculo: <span id="displayGrossuraCirculo">28</span> px
          </label>
          <input type="range" id="grossuraCirculo" min="1" max="40" value="28" />
        </div>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="circuloContornoAtivo" onchange="toggleContorno('circulo')">
            <label for="circuloContornoAtivo">Ativar contorno do c√≠rculo</label>
          </div>
        </div>
        <div id="grupoCirculoContorno" style="display: none;">
          <div class="grupo">
            <label>Cor do contorno do c√≠rculo:</label>
            <div class="linha-color">
              <input type="color" id="corCirculoContorno" value="#000000" />
              <input type="text" id="hexCirculoContorno" value="#000000" />
            </div>
          </div>
          <div class="grupo">
            <label for="grossuraCirculoContorno">
              Grossura do contorno: <span id="displayGrossuraCirculoContorno">2</span> px
            </label>
            <input type="range" id="grossuraCirculoContorno" min="1" max="20" value="2" />
          </div>
          <div class="grupo">
            <label>Tipo de linha:</label>
            <select id="tipoCirculoContorno">
              <option value="solid">S√≥lido</option>
              <option value="dashed">Tracejado</option>
              <option value="dotted">Pontilhado</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Configura√ß√£o da Borda -->
      <div class="secao">
        <h2>Configura√ß√£o da Borda</h2>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="bordaTransparente" onchange="atualizarCampo('borda')">
            <label for="bordaTransparente">Borda transparente</label>
          </div>
          <label>Cor da borda:</label>
          <div class="linha-color">
            <input type="color" id="corBorda" value="#2D3E50" />
            <input type="text" id="hexBorda" value="#2D3E50" />
          </div>
        </div>
        <div class="grupo">
          <label for="grossuraBorda">
            Grossura da borda: <span id="displayGrossuraBorda">5</span> px
          </label>
          <input type="range" id="grossuraBorda" min="1" max="40" value="5" />
        </div>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="bordaContornoAtivo" onchange="toggleContorno('borda')">
            <label for="bordaContornoAtivo">Ativar contorno da borda</label>
          </div>
        </div>
        <div id="grupoBordaContorno" style="display: none;">
          <div class="grupo">
            <label>Cor do contorno da borda:</label>
            <div class="linha-color">
              <input type="color" id="corBordaContorno" value="#000000" />
              <input type="text" id="hexBordaContorno" value="#000000" />
            </div>
          </div>
          <div class="grupo">
            <label for="grossuraBordaContorno">
              Grossura do contorno: <span id="displayGrossuraBordaContorno">2</span> px
            </label>
            <input type="range" id="grossuraBordaContorno" min="1" max="20" value="2" />
          </div>
          <div class="grupo">
            <label>Tipo de linha:</label>
            <select id="tipoBordaContorno">
              <option value="solid">S√≥lido</option>
              <option value="dashed">Tracejado</option>
              <option value="dotted">Pontilhado</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Coluna 2: Texto e Fundo -->
    <div class="col">
      <!-- Configura√ß√£o do Texto -->
      <div class="secao">
        <h2>Configura√ß√£o do Texto</h2>
        <div class="grupo">
          <label>Cor do texto:</label>
          <div class="linha-color">
            <input type="color" id="corTexto" value="#ffffff" />
            <input type="text" id="hexTexto" value="#ffffff" />
          </div>
        </div>
        <div class="grupo">
          <label for="tamanhoTexto">
            Tamanho do texto: <span id="displayTamanhoTexto">90</span> px
          </label>
          <input type="range" id="tamanhoTexto" min="10" max="100" value="90" />
        </div>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="textoContornoAtivo" onchange="toggleContorno('texto')">
            <label for="textoContornoAtivo">Ativar contorno do texto</label>
          </div>
        </div>
        <div id="grupoTextoContorno" style="display: none;">
          <div class="grupo">
            <label>Cor do contorno do texto:</label>
            <div class="linha-color">
              <input type="color" id="corTextoContorno" value="#000000" />
              <input type="text" id="hexTextoContorno" value="#000000" />
            </div>
          </div>
          <div class="grupo">
            <label for="grossuraTextoContorno">
              Grossura do contorno: <span id="displayGrossuraTextoContorno">2</span> px
            </label>
            <input type="range" id="grossuraTextoContorno" min="1" max="20" value="2" />
          </div>
          <div class="grupo">
            <label>Tipo de linha:</label>
            <select id="tipoTextoContorno">
              <option value="solid">S√≥lido</option>
              <option value="dashed">Tracejado</option>
              <option value="dotted">Pontilhado</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Configura√ß√£o do Fundo -->
      <div class="secao">
        <h2>Configura√ß√£o do Fundo</h2>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="fundoTransparente" checked onchange="atualizarCampo('fundo')">
            <label for="fundoTransparente">Fundo transparente</label>
          </div>
          <label>Cor do fundo:</label>
          <div class="linha-color">
            <input type="color" id="corFundo" value="#000000" disabled />
            <input type="text" id="hexFundo" value="transparent" disabled />
          </div>
        </div>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="fundoContornoAtivo" onchange="toggleContorno('fundo')">
            <label for="fundoContornoAtivo">Ativar contorno do fundo</label>
          </div>
        </div>
        <div id="grupoFundoContorno" style="display: none;">
          <div class="grupo">
            <label>Cor do contorno do fundo:</label>
            <div class="linha-color">
              <input type="color" id="corFundoContorno" value="#000000" />
              <input type="text" id="hexFundoContorno" value="#000000" />
            </div>
          </div>
          <div class="grupo">
            <label for="grossuraFundoContorno">
              Grossura do contorno: <span id="displayGrossuraFundoContorno">2</span> px
            </label>
            <input type="range" id="grossuraFundoContorno" min="1" max="20" value="2" />
          </div>
          <div class="grupo">
            <label>Tipo de linha:</label>
            <select id="tipoFundoContorno">
              <option value="solid">S√≥lido</option>
              <option value="dashed">Tracejado</option>
              <option value="dotted">Pontilhado</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Coluna 3: Sombra e Tra√ßado do C√≠rculo -->
    <div class="col">
      <!-- Configura√ß√£o da Sombra -->
      <div class="secao">
        <h2>Configura√ß√£o da Sombra</h2>
        <div class="grupo">
          <div class="linha-check">
            <input type="checkbox" id="sombraTransparente" onchange="toggleSombra()">
            <label for="sombraTransparente">Sombra transparente</label>
          </div>
          <label>Cor da sombra:</label>
          <div class="linha-color">
            <input type="color" id="corSombra" value="#000000" />
            <input type="text" id="hexSombra" value="#000000" />
          </div>
        </div>
        <div id="grupoSombra">
          <div class="grupo">
            <label>Intensidade da sombra:</label>
            <input type="range" id="sombra" min="0" max="30" value="8" />
          </div>
          <div class="grupo">
            <label>Dire√ß√£o da sombra (horizontal):</label>
            <input type="range" id="sombraX" min="-30" max="30" value="4" />
          </div>
          <div class="grupo">
            <label>Dire√ß√£o da sombra (vertical):</label>
            <input type="range" id="sombraY" min="-30" max="30" value="4" />
          </div>
        </div>
        <button onclick="iniciarContagem()">Gerar GIF</button>
		<button id="cancelButton" onclick="cancelProcess()" style="display: none;">Cancelar</button>
        <button class="btn-reset" onclick="resetarPadroes()">Resetar Padr√µes</button>
        <div id="status">Aguardando...</div>
		
		
      </div>
      <!-- Tra√ßado do C√≠rculo -->
      <div class="secao">
        <h2>Tra√ßado do C√≠rculo</h2>
        <div class="grupo">
          <label>Tipo de tra√ßo do c√≠rculo:</label>
          <select id="tipoTraco">
            <option value="solid" selected>S√≥lido</option>
            <option value="dashed">Tracejado</option>
            <option value="dotted">Pontilhado</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Coluna 4: Pr√©-visualiza√ß√£o e GIF final para download -->
    <div class="col preview">
      <div class="secao">
        <canvas id="canvas" width="500" height="500"
        style="width:300px;height:300px;"></canvas>
        <p style="margin-top: 12px;">Pr√©-visualiza√ß√£o</p>
      </div>
      <div class="secao">
        <h2>GIF Final para Download</h2>
        <div id="gifDownload">
          <p>Aguardando...</p>
		  
        </div>
				<div id="progressWrapper" style="margin-top: 12px;">
  <div id="progressBarOuter">
    <div id="progressBarInner"></div>
  </div>
  <div id="progressPercent">0%</div>
</div>
		
		
      </div>
    </div>
  
  </div>
  
  
  
  
  <script>
/* ====== SETUP DO CANVAS COM ALTA DENSIDADE ====== */
const LOGICAL_SIZE = 300;                   // Tamanho "vis√≠vel"
const scale = window.devicePixelRatio || 2; // Se n√£o tiver devicePixelRatio, assume 25

const canvas = document.getElementById("canvas");
canvas.width  = LOGICAL_SIZE * scale;       // Ex.: 600 px se scale = 2
canvas.height = LOGICAL_SIZE * scale;
canvas.style.width  = LOGICAL_SIZE + "px";    // Continua 300x300 na p√°gina
canvas.style.height = LOGICAL_SIZE + "px";

const ctx = canvas.getContext("2d");
ctx.scale(scale, scale);                    // Mant√©m as coordenadas l√≥gicas

/* ================================================ */

const status      = document.getElementById("status");
const gifDownload = document.getElementById("gifDownload");
let frames = [];
let tempoTotal = parseInt(document.getElementById("initialTime").value) || 30;
let sombraAnterior = "#000000";

/* ==================== UTILIDADES ==================== */
const hex = id => document.getElementById(`hex${id}`).value || "transparent";
const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);

/* ================= CONTROLE DE UI =================== */
function desabilitarControles() {
  document.querySelectorAll(".container input, .container select, .container button")
          .forEach(el => el.disabled = true);
}

function habilitarControles() {
  document.querySelectorAll(".container input, .container select, .container button")
          .forEach(el => el.disabled = false);
  if (document.getElementById("fundoTransparente").checked) {
    document.getElementById("corFundo").disabled = true;
    document.getElementById("hexFundo").disabled = true;
  }
  if (document.getElementById("sombraTransparente").checked) {
    document.getElementById("corSombra").disabled = true;
    document.getElementById("hexSombra").disabled = true;
  }
}

function atualizarCampo(tipo) {
  if (document.getElementById(`cor${capitalize(tipo)}`) && document.getElementById(`hex${capitalize(tipo)}`)) {
    const cb = document.getElementById(`${tipo}Transparente`) || document.getElementById(`${tipo}ContornoAtivo`);
    const color    = document.getElementById(`cor${capitalize(tipo)}`);
    const hexField = document.getElementById(`hex${capitalize(tipo)}`);
    if (cb && cb.checked) {
      hexField.value = "transparent";
      color.disabled = true;
      hexField.disabled = true;
    } else {
      color.disabled = false;
      hexField.disabled = false;
      hexField.value = color.value;
    }
  }
  desenharFrame(0, tempoTotal);
}

function toggleContorno(tipo) {
  const check = document.getElementById(`${tipo}ContornoAtivo`);
  const grupo = document.getElementById(`grupo${capitalize(tipo)}Contorno`);
  grupo.style.display = check.checked ? "block" : "none";
  atualizarCampo(`${tipo}Contorno`);
}

function toggleSombra() {
  const check      = document.getElementById("sombraTransparente");
  const grupoSombra = document.getElementById("grupoSombra");
  const corSombra   = document.getElementById("corSombra");
  const hexSombra   = document.getElementById("hexSombra");

  if (check.checked) {
    sombraAnterior = corSombra.value;
    grupoSombra.style.display = "none";
    hexSombra.value = "transparent";
    corSombra.disabled = true;
    hexSombra.disabled = true;
  } else {
    grupoSombra.style.display = "block";
    corSombra.disabled = false;
    hexSombra.disabled = false;
    if (hexSombra.value === "transparent") {
      corSombra.value = sombraAnterior;
      hexSombra.value = sombraAnterior;
    }
  }
  desenharFrame(0, tempoTotal);
}

["Circulo", "Borda", "Texto", "Fundo", "Sombra", "TextoContorno"].forEach(tipo => {
  document.getElementById(`cor${tipo}`).addEventListener("input", e => {
    document.getElementById(`hex${tipo}`).value = e.target.value;
    desenharFrame(0, tempoTotal);
  });
  document.getElementById(`hex${tipo}`).addEventListener("input", e => {
    document.getElementById(`cor${tipo}`).value = e.target.value;
    desenharFrame(0, tempoTotal);
  });
});

/* ======== LISTENERS DE SLIDERS E SELECTS ======== */
const binds = [
  ["tamanhoTexto", "displayTamanhoTexto"],
  ["grossuraBordaContorno", "displayGrossuraBordaContorno"],
  ["grossuraCirculoContorno", "displayGrossuraCirculoContorno"],
  ["grossuraTextoContorno", "displayGrossuraTextoContorno"],
  ["grossuraFundoContorno", "displayGrossuraFundoContorno"],
  ["grossuraCirculo", "displayGrossuraCirculo"],
  ["grossuraBorda", "displayGrossuraBorda"]
];
binds.forEach(([input, span]) => {
  document.getElementById(input).addEventListener("input", e => {
    document.getElementById(span).textContent = e.target.value;
    desenharFrame(0, tempoTotal);
  });
});

document.getElementById("sombra").addEventListener("input", () => desenharFrame(0, tempoTotal));
document.getElementById("sombraX").addEventListener("input", () => desenharFrame(0, tempoTotal));
document.getElementById("sombraY").addEventListener("input", () => desenharFrame(0, tempoTotal));
document.getElementById("tipoTraco").addEventListener("change", () => desenharFrame(0, tempoTotal));

document.getElementById("initialTime").addEventListener("input", () => {
  tempoTotal = parseInt(document.getElementById("initialTime").value) || 0;
  desenharFrame(0, tempoTotal);
});

/* ================= DESENHO ================= */
function desenharFrame(progresso, tempoRestante) {
  const centro = 150, raio = 100;
  const anguloInicio = -Math.PI / 2;
  const anguloFim = anguloInicio + Math.min(progresso, 1) * 2 * Math.PI;
  const corFundo   = hex("Fundo");
  const corBorda   = hex("Borda");
  const corCirculo = hex("Circulo");
  const corTexto   = hex("Texto");
  const corSombra  = hex("Sombra");
  const tipoTraco  = document.getElementById("tipoTraco").value;
  const sombra     = +document.getElementById("sombra").value;
  const offsetX    = +document.getElementById("sombraX").value;
  const offsetY    = +document.getElementById("sombraY").value;
  const tamanhoTexto    = +document.getElementById("tamanhoTexto").value;
  const grossuraCirculo = +document.getElementById("grossuraCirculo").value;
  const grossuraBorda   = +document.getElementById("grossuraBorda").value;

  // Limpeza do canvas antes de come√ßar a desenhar
  ctx.clearRect(0, 0, LOGICAL_SIZE, LOGICAL_SIZE);  // Limpa o canvas, garantindo que o fundo seja transparente

  // Condi√ß√£o para desenhar o fundo (s√≥ se fundo n√£o for transparente)
  if (corFundo !== "transparent" && !document.getElementById("fundoTransparente").checked) {
    ctx.fillStyle = corFundo;
    ctx.fillRect(0, 0, LOGICAL_SIZE, LOGICAL_SIZE); // Preenche o fundo com a cor escolhida
  }

  // Contorno do fundo
  if (document.getElementById("fundoContornoAtivo")?.checked) {
    const cor      = document.getElementById("hexFundoContorno").value;
    const grossura = +document.getElementById("grossuraFundoContorno").value;
    const tipo     = document.getElementById("tipoFundoContorno").value;
    ctx.beginPath();
    ctx.setLineDash(tipo === "dashed" ? [10,10] : tipo === "dotted" ? [2,6] : []);
    ctx.strokeStyle = cor;
    ctx.lineWidth   = grossura;
    ctx.strokeRect(0, 0, LOGICAL_SIZE, LOGICAL_SIZE);
  }

  // Borda
  if (corBorda !== "transparent") {
    ctx.beginPath();
    ctx.setLineDash([]);
    ctx.arc(centro, centro, raio, 0, 2 * Math.PI);
    ctx.strokeStyle   = corBorda;
    ctx.lineWidth     = grossuraBorda;
    ctx.shadowBlur    = sombra;
    ctx.shadowOffsetX = offsetX;
    ctx.shadowOffsetY = offsetY;
    ctx.shadowColor   = corSombra;
    ctx.stroke();
  }

  // Contorno da borda
  if (document.getElementById("bordaContornoAtivo")?.checked) {
    const cor      = document.getElementById("hexBordaContorno").value;
    const grossura = +document.getElementById("grossuraBordaContorno").value;
    const tipo     = document.getElementById("tipoBordaContorno").value;
    ctx.beginPath();
    ctx.setLineDash(tipo === "dashed" ? [10,10] : tipo === "dotted" ? [2,6] : []);
    ctx.arc(centro, centro, raio, 0, 2 * Math.PI);
    ctx.strokeStyle = cor;
    ctx.lineWidth   = grossura;
    ctx.stroke();
  }

  // C√≠rculo progressivo
  if (corCirculo !== "transparent") {
    ctx.beginPath();
    ctx.setLineDash(tipoTraco === "dashed" ? [10,10] : tipoTraco === "dotted" ? [2,6] : []);
    ctx.arc(centro, centro, raio, anguloInicio, anguloFim);
    ctx.strokeStyle   = corCirculo;
    ctx.lineCap = "round";  // Isso adiciona o arredondamento nas pontas da barra
	ctx.lineWidth = grossuraCirculo;
    ctx.shadowBlur    = sombra;
    ctx.shadowOffsetX = offsetX;
    ctx.shadowOffsetY = offsetY;
    ctx.shadowColor   = corSombra;
    ctx.stroke();
  }

  // Contorno do c√≠rculo
  if (document.getElementById("circuloContornoAtivo")?.checked) {
    const cor      = document.getElementById("hexCirculoContorno").value;
    const grossura = +document.getElementById("grossuraCirculoContorno").value;
    const tipo     = document.getElementById("tipoCirculoContorno").value;
    ctx.beginPath();
    ctx.setLineDash(tipo === "dashed" ? [10,10] : tipo === "dotted" ? [2,6] : []);
    ctx.arc(centro, centro, raio, anguloInicio, anguloFim);
    ctx.strokeStyle = cor;
    ctx.lineWidth   = grossura;
    ctx.stroke();
  }

  // Texto
  ctx.fillStyle      = corTexto;
  ctx.shadowBlur     = sombra;
  ctx.shadowOffsetX  = offsetX;
  ctx.shadowOffsetY  = offsetY;
  ctx.shadowColor    = corSombra;
  ctx.font           = `bold ${tamanhoTexto}px Arial`;
  ctx.textAlign      = "center";
  ctx.textBaseline   = "middle";
  ctx.fillText(tempoRestante.toString(), centro, centro);

  // Contorno do texto
  if (document.getElementById("textoContornoAtivo")?.checked) {
    const cor      = document.getElementById("hexTextoContorno").value;
    const grossura = +document.getElementById("grossuraTextoContorno").value;
    const tipo     = document.getElementById("tipoTextoContorno").value;
    ctx.beginPath();
    ctx.setLineDash(tipo === "dashed" ? [10,10] : tipo === "dotted" ? [2,6] : []);
    ctx.strokeStyle = cor;
    ctx.lineWidth   = grossura;
    ctx.strokeText(tempoRestante.toString(), centro, centro);
  }
}

/* ================== CONTAGEM ================== */

function iniciarContagem() {
 
  desabilitarControles();
  frames = [];
  cancelRequested = false;
  document.getElementById("cancelButton").disabled = false; // ‚Üê HABILITA O BOT√ÉO
  document.getElementById("cancelButton").style.display = "inline-block"; // ‚Üê MOSTRA O BOT√ÉO
  const tempoTotalSegundos = tempoTotal;
  status.textContent = "Contando...";
  gifDownload.innerHTML = "<p>Contando...</p>";
 
 

  let startTime = null;
  let lastFrameTime = 0;
  
  
  function animationLoop(timestamp) {
  if (cancelRequested) {
    status.textContent = "Processo cancelado!";
    gifDownload.innerHTML = "<p>O processo foi cancelado.</p>";
    habilitarControles();
    return;
  }

  if (!startTime) startTime = timestamp;
  const elapsed = (timestamp - startTime) / 1000;
  let tempoRestante = tempoTotalSegundos - elapsed;
  if (tempoRestante < 0) tempoRestante = 0;
  const progresso = elapsed / tempoTotalSegundos;

  desenharFrame(progresso, Math.floor(tempoRestante));

  if (timestamp - lastFrameTime >= 50) {
    frames.push(canvas.toDataURL("image/png"));
    lastFrameTime = timestamp;
  }

  gifDownload.innerHTML = `<p>Tempo estimado para finaliza√ß√£o: ${Math.floor(tempoRestante)} segundos</p>`;

  if (elapsed < tempoTotalSegundos) {
    requestAnimationFrame(animationLoop);
  } else {
    // Passo 1: Come√ßar a preencher a barra de progresso
    status.textContent = "Enviando para o servidor...";
    gifDownload.innerHTML = "<p>Enviando para o servidor...</p>";

    // Passo 2: A fun√ß√£o de anima√ß√£o
    const progressBar = document.getElementById("progressBarInner");
    const progressText = document.getElementById("progressPercent");

    let progress = 0; // A barra come√ßa em 0%

    // Passo 3: A anima√ß√£o para preencher a barra
    const interval = setInterval(() => {
      // Para os primeiros 2 segundos, aumentamos de 0 a 50%
      if (elapsed <= 2) {
        progress = (elapsed / 2) * 50; // De 0 a 50% nos primeiros 2 segundos
      }
      // De 3 a 5 segundos, aumentamos de 50 a 80%
      else if (elapsed > 2 && elapsed <= 5) {
        progress = 50 + ((elapsed - 2) / 3) * 30; // De 50 a 80% nos pr√≥ximos 3 segundos
      } else if (elapsed > 5) {
        progress = 80;  // A barra vai parar em 80% depois dos 5 segundos
      }

      // Atualiza a barra de progresso
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${Math.floor(progress)}%`;

      // Ap√≥s atingir 80%, a barra estagna
      if (progress >= 80) {
        clearInterval(interval); // Interrompe o intervalo para n√£o ultrapassar 80%
        
        // Aguarda resposta do servidor, a√≠ sim vai para 100%
        enviarParaServidor(frames);
      }
    }, 100); // A cada 100ms (5 segundos)
  }
}

// Fun√ß√£o para enviar para o servidor e gerar o GIF

function enviarParaServidor(frames) {
  fetch('/api/gerar-gif', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ frames })
  })
  .then(response => response.json())
  .then(data => {
    // A resposta cont√©m a URL do GIF gerado
    const gifUrl = data.url;

    // Exibir a barra de progresso enquanto o GIF √© gerado
    const progressBar = document.getElementById("progressBarInner");
    const progressText = document.getElementById("progressPercent");

    let progress = 80; // Come√ßa em 80%

    const interval = setInterval(() => {
      progress += 2; // Incrementa 2% a cada 100ms
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${Math.floor(progress)}%`;

      // Finaliza a anima√ß√£o quando atinge 100%
      if (progress >= 100) {
        clearInterval(interval);

        // Liberar todos os campos (resetar padr√µes)
        habilitarControles();

        // Destacar o link de download
        gifDownload.innerHTML = `
          <p>GIF gerado com sucesso!</p>
          <a href="${gifUrl}" download="cronometro.gif" class="btn-download pulsante">Baixar GIF</a>
        `;
        
        // Estilo para o bot√£o pulsante
        document.querySelector(".pulsante").style.animation = "pulse 1s infinite"; 
      }
    }, 100); // A cada 100ms (5 segundos)

  })
  .catch(error => {
    console.error('Erro ao enviar os frames para o servidor:', error);
    alert('Erro ao gerar o GIF. Tente novamente.');
  });
}

// Adicionar anima√ß√£o de destaque ao bot√£o
const style = document.createElement('style');
style.innerHTML = `
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  .pulsante {
    background-color: #007bff;
    color: white;
    font-weight: bold;
    padding: 14px 20px;
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .pulsante:hover {
    background-color: #0056b3;
  }
`;
document.head.appendChild(style);

  
  
  
  
  
  
  
  
  

  requestAnimationFrame(animationLoop);
}

let cancelRequested = false; // ‚Üê DECLARA√á√ÉO GLOBAL AQUI






// Fun√ß√£o para cancelamento
function cancelProcess() {
  cancelRequested = true;  // Marca que o processo foi cancelado
  habilitarControles();    // Habilita os controles novamente
  status.textContent = "Processo cancelado!";
  document.getElementById("cancelButton").style.display = "none"; // ‚Üê esconde o bot√£o
  gifDownload.innerHTML = "<p>O processo foi cancelado.</p>";
}


/* ================= RESETAR PADR√ïES ================= */
function resetarPadroes() {
  // Definir valores padr√£o para os elementos
  document.getElementById("initialTime").value = 30;
  tempoTotal = 30;

  // C√çRCULO
  document.getElementById("circuloTransparente").checked = false;
  document.getElementById("corCirculo").value = "#FF0000";  // Vermelho
  document.getElementById("hexCirculo").value = "#FF0000";  // Vermelho
  document.getElementById("grossuraCirculo").value = 35;  // 35 px
  document.getElementById("displayGrossuraCirculo").textContent = 35;
  document.getElementById("circuloContornoAtivo").checked = false;
  document.getElementById("grupoCirculoContorno").style.display = "none";
  document.getElementById("corCirculoContorno").value = "#000000";  // Preto (sem contorno)
  document.getElementById("hexCirculoContorno").value = "#000000";
  document.getElementById("grossuraCirculoContorno").value = 2;
  document.getElementById("displayGrossuraCirculoContorno").textContent = 2;
  document.getElementById("tipoCirculoContorno").value = "solid";

  // BORDA
  document.getElementById("bordaTransparente").checked = false;
  document.getElementById("corBorda").value = "#2E2E2E";  // Cinza bem escuro
  document.getElementById("hexBorda").value = "#2E2E2E";  // Cinza bem escuro
  document.getElementById("grossuraBorda").value = 34;  // 34 px
  document.getElementById("displayGrossuraBorda").textContent = 34;
  document.getElementById("bordaContornoAtivo").checked = false;
  document.getElementById("grupoBordaContorno").style.display = "none";
  document.getElementById("corBordaContorno").value = "#000000";  // Preto (sem contorno)
  document.getElementById("hexBordaContorno").value = "#000000";
  document.getElementById("grossuraBordaContorno").value = 2;
  document.getElementById("displayGrossuraBordaContorno").textContent = 2;
  document.getElementById("tipoBordaContorno").value = "solid";

  // TEXTO
  document.getElementById("corTexto").value = "#FF0000";  // Vermelho
  document.getElementById("hexTexto").value = "#FF0000";  // Vermelho
  document.getElementById("tamanhoTexto").value = 90;
  document.getElementById("displayTamanhoTexto").textContent = 90;
  document.getElementById("textoContornoAtivo").checked = false;
  document.getElementById("grupoTextoContorno").style.display = "none";
  document.getElementById("corTextoContorno").value = "#000000";  // Preto (sem contorno)
  document.getElementById("hexTextoContorno").value = "#000000";
  document.getElementById("grossuraTextoContorno").value = 2;
  document.getElementById("displayGrossuraTextoContorno").textContent = 2;
  document.getElementById("tipoTextoContorno").value = "solid";

  // FUNDO
  document.getElementById("fundoTransparente").checked = true;
  document.getElementById("corFundo").value = "#000000";
  document.getElementById("hexFundo").value = "transparent";
  document.getElementById("corFundo").disabled = true;
  document.getElementById("hexFundo").disabled = true;
  document.getElementById("fundoContornoAtivo").checked = false;
  document.getElementById("grupoFundoContorno").style.display = "none";
  document.getElementById("corFundoContorno").value = "#000000";
  document.getElementById("hexFundoContorno").value = "#000000";
  document.getElementById("grossuraFundoContorno").value = 2;
  document.getElementById("displayGrossuraFundoContorno").textContent = 2;
  document.getElementById("tipoFundoContorno").value = "solid";

  // SOMBRA
  document.getElementById("sombraTransparente").checked = true;  // Sombra transparente
  document.getElementById("corSombra").value = "#FFFFFF";  // Branco (transparente)
  document.getElementById("hexSombra").value = "#FFFFFF";  // Branco (transparente)
  document.getElementById("corSombra").disabled = true;
  document.getElementById("hexSombra").disabled = true;
  document.getElementById("grupoSombra").style.display = "none";
  document.getElementById("sombra").value = 0;  // Sem sombra
  document.getElementById("sombraX").value = 0;
  document.getElementById("sombraY").value = 0;
  sombraAnterior = "#FFFFFF";
  
    // Resetar barra de progresso
  const progressBar = document.getElementById("progressBarInner");
  const progressText = document.getElementById("progressPercent");
  progressBar.style.width = '0%';  // Zera a barra de progresso
  progressText.textContent = '0%'; // Zera o percentual

  // TRA√áADO
  document.getElementById("tipoTraco").value = "solid";

  // Redesenha preview
  desenharFrame(0, tempoTotal);
}

/* ================== INICIALIZA√á√ÉO ================== */
document.addEventListener("DOMContentLoaded", () => {
  // Inicializa a p√°gina com as configura√ß√µes padr√£o
  tempoTotal = +document.getElementById("initialTime").value || 30;
  resetarPadroes(); // Aplica as configura√ß√µes padr√£o imediatamente
  desenharFrame(0, tempoTotal);
});
</script>





</body>
</html>